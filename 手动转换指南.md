# 手动转换om模型指南

##
由yolo(`.pt`)或其他模型转换得到的`.onnx`模型，利用`atc`工具转化为`.om`模型。

需要python环境，建议使用conda管理;

如果主机没有conda或miniconda，安装miniconda：

```
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
 
bash Miniconda3-latest-Linux-x86_64.sh
```
执行安装脚本，根据提示进行回车或者`yes`

安装后可查看版本以验证
```
source ~/.bashrc
 
#验证
conda --version
```

##

安装后，创建所需要的python环境

终端执行：

```
conda create -n atc python=3.9.2
conda activate atc
 
pip3 install protobuf==3.13.0 -i https://pypi.tuna.tsinghua.edu.cn/simple
pip3 install psutil==5.7.0 -i https://pypi.tuna.tsinghua.edu.cn/simple
pip3 install numpy==2.0.2 -i https://pypi.tuna.tsinghua.edu.cn/simple
pip3 install scipy==1.13.1 -i https://pypi.tuna.tsinghua.edu.cn/simple
pip3 install decorator==4.4.0 -i https://pypi.tuna.tsinghua.edu.cn/simple
pip3 install sympy==1.5.1 -i https://pypi.tuna.tsinghua.edu.cn/simple
pip3 install cffi==1.12.3 -i https://pypi.tuna.tsinghua.edu.cn/simple
pip3 install pyyaml==6.0.2 -i https://pypi.tuna.tsinghua.edu.cn/simple
pip3 install pathlib2 -i https://pypi.tuna.tsinghua.edu.cn/simple
```

##

在当前conda环境下，可以使用atc工具进行转换

atc工具由昇腾官方cann工具包安装提供，这里已经打包安装好，在`Ascend`文件夹内；

执行配置脚本（需要按照using_atc包文件位置，修改配置脚本位置）

可以验证atc工具是否存在

终端执行：

```
export TOOLKIT_ROOT=/home/why/to_om/using_atc/
source /home/why/to_om/using_atc/Ascend/ascend-toolkit/latest/x86_64-linux/bin/setenv.bash

which atc
```
配置脚本内容如下：
```
#!/usr/bin/env bash

# 检查 TOOLKIT_ROOT 是否设置
if [ -z "$TOOLKIT_ROOT" ]; then
    echo "[ERROR] TOOLKIT_ROOT not set."
    echo "请先设置 Ascend Toolkit 安装路径，比如："
    echo "  export TOOLKIT_ROOT=/home/why/to_om/using_atc/"
    exit 1
fi

source $TOOLKIT_ROOT/Ascend/ascend-toolkit/5.20.t6.2.b060/x86_64-linux/compiler/bin/setenv.bash
source $TOOLKIT_ROOT/Ascend/ascend-toolkit/5.20.t6.2.b060/x86_64-linux/runtime/bin/setenv.bash
source $TOOLKIT_ROOT/Ascend/ascend-toolkit/5.20.t6.2.b060/x86_64-linux/opp/bin/setenv.bash
source $TOOLKIT_ROOT/Ascend/ascend-toolkit/5.20.t6.2.b060/x86_64-linux/toolkit/bin/setenv.bash
```
##

转化

确保有atc工具，在上述环境下执行转换

确保待转换模型位于`run`目录下

终端执行：
```
cd run

atc --model=test.onnx --framework=5 --output=out --soc_version="OPTG" --output_type=FP32 --insert_op_conf=./op.cfg
```

参数说明

`model` 模型名称，根据具体模型名称修改

`output` 输出名称，决定了输出`.om`模型的命名（不需要加.om）

`insert_op_conf` 配置文件，已经写好修改好。

**模型转化前，需要确保模型图像输入量为640*640**

转化过程需要一定时间，同时要求虚拟机或主机拥有大量内存以供运行。终端提示转换成功后，可以在`run`目录下找到`out.om`文件，即为输出。

##

也可参考CSDN博客：

```
https://blog.csdn.net/2301_81299450/article/details/149393758?sharetype=blogdetail&sharerId=149393758&sharerefer=PC&sharesource=2301_81299450&spm=1011.2480.3001.8118
```